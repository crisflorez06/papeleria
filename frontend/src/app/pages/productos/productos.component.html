<div class="row">
  <!-- Filtros de búsqueda -->
  <div>
    <mat-accordion class="mx-5" *ngIf="vistaActual === 'productos'">
      <mat-expansion-panel [(expanded)]="filtrosAbiertos">
        <mat-expansion-panel-header>
          <mat-panel-title>Filtros de búsqueda</mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Fila 1 -->
        <div class="row my-3 mx-1">
          <div class="col">
            <label for="nombre" class="form-label">Nombre</label>
            <input
              id="nombre"
              type="text"
              class="form-control"
              placeholder="Ingrese el nombre del producto"
              [(ngModel)]="filtros.nombre"
              name="nombre"
            />
          </div>

          <div class="col">
            <label for="categoria" class="form-label">Categoría</label>
            <select
              id="categoria"
              class="form-select"
              [(ngModel)]="filtros.categoria"
              name="categoria"
            >
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let categoria of categoriasProductos" [value]="categoria">
                {{ categoria }}
              </option>
            </select>
          </div>
          <div class="col">
            <label for="estado" class="form-label">Estado del registro</label>
            <select id="estado" class="form-select" [(ngModel)]="filtros.estado" name="estado">
              <option [ngValue]="true">Activo</option>
              <option [ngValue]="false">Inactivo</option>
            </select>
          </div>
        </div>

        <!-- Acciones del panel -->
        <div class="d-flex gap-2 justify-content-end mb-2 mx-1">
          <button class="btn btn-outline-secondary" (click)="limpiarFiltros()">Limpiar</button>
          <button class="btn btn-primary" (click)="aplicarFiltros()">Buscar</button>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
    <mat-accordion class="mx-5" *ngIf="vistaActual === 'movimientos'">
      <mat-expansion-panel [(expanded)]="filtrosAbiertos">
        <mat-expansion-panel-header>
          <mat-panel-title>Filtros de movimientos</mat-panel-title>
        </mat-expansion-panel-header>

        <div class="row my-3 mx-1">
          <div class="col-md-3">
            <label for="movimientoProducto" class="form-label">Producto</label>
            <select
              id="movimientoProducto"
              class="form-select"
              [(ngModel)]="filtrosMovimientos.productoId"
              name="movimientoProducto"
            >
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let producto of nombresProductos" [ngValue]="producto.id">
                {{ producto.nombre }}
              </option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="movimientoTipo" class="form-label">Tipo</label>
            <select
              id="movimientoTipo"
              class="form-select"
              [(ngModel)]="filtrosMovimientos.tipo"
              name="movimientoTipo"
            >
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let tipo of tiposMovimiento" [value]="tipo">
                {{ tipo }}
              </option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="movimientoDesde" class="form-label">Desde</label>
            <input
              id="movimientoDesde"
              type="date"
              class="form-control"
              [(ngModel)]="filtrosMovimientos.desde"
              name="movimientoDesde"
            />
          </div>
          <div class="col-md-3">
            <label for="movimientoHasta" class="form-label">Hasta</label>
            <input
              id="movimientoHasta"
              type="date"
              class="form-control"
              [(ngModel)]="filtrosMovimientos.hasta"
              name="movimientoHasta"
            />
          </div>
        </div>

        <div class="d-flex gap-2 justify-content-end mb-2 mx-1">
          <button class="btn btn-outline-secondary" (click)="limpiarFiltrosMovimientos()">
            Limpiar
          </button>
          <button class="btn btn-primary" (click)="aplicarFiltrosMovimientos()">Buscar</button>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>

  <!-- Acciones -->
  <div
    class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3 mt-3 px-3"
  >
    <div class="d-flex align-items-center gap-2">
      <button
        type="button"
        class="btn btn-outline-primary btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#productoModal"
        (click)="abrirModalCrearProducto()"
      >
        Crear Producto
      </button>
      <button
        type="button"
        class="btn btn-outline-success btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#ingresarProductosModal"
        (click)="abrirModalIngresarProductos()"
      >
        Ingresar Productos
      </button>
    </div>
    <div class="btn-group">
      <button
        type="button"
        class="btn btn-sm"
        [ngClass]="vistaActual === 'productos' ? 'btn-primary' : 'btn-outline-primary'"
        (click)="mostrarProductos()"
      >
        Ver Productos
      </button>
      <button
        type="button"
        class="btn btn-sm"
        [ngClass]="vistaActual === 'movimientos' ? 'btn-primary' : 'btn-outline-primary'"
        (click)="mostrarMovimientos()"
      >
        Ver Movimientos
      </button>
    </div>
  </div>

  <!-- Tabla de productos -->
  <div class="container mt-4" *ngIf="vistaActual === 'productos'">
    <h2 class="mb-3 text-center">Registro de productos</h2>

    <div class="table-responsive shadow-sm rounded">
      <table class="table table-hover align-middle border text-center">
        <thead class="table-dark">
          <tr>
            <th
              scope="col"
              class="border-end"
              (click)="ordenarPor('nombre')"
              style="cursor: pointer"
            >
              Nombre
              <i
                *ngIf="sortColumn === 'nombre'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirection === 'asc',
                  'bi-caret-down-fill': sortDirection === 'desc'
                }"
              ></i>
            </th>

            <th
              scope="col"
              class="border-end"
              (click)="ordenarPor('categoria')"
              style="cursor: pointer"
            >
              Categoría
              <i
                *ngIf="sortColumn === 'categoria'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirection === 'asc',
                  'bi-caret-down-fill': sortDirection === 'desc'
                }"
              ></i>
            </th>

            <th
              scope="col"
              class="border-end"
              (click)="ordenarPor('precioCompra')"
              style="cursor: pointer"
            >
              Precio Compra
              <i
                *ngIf="sortColumn === 'precioCompra'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirection === 'asc',
                  'bi-caret-down-fill': sortDirection === 'desc'
                }"
              ></i>
            </th>

            <th
              scope="col"
              class="border-end"
              (click)="ordenarPor('precioVenta')"
              style="cursor: pointer"
            >
              Precio Venta
              <i
                *ngIf="sortColumn === 'precioVenta'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirection === 'asc',
                  'bi-caret-down-fill': sortDirection === 'desc'
                }"
              ></i>
            </th>

            <th
              scope="col"
              class="border-end"
              (click)="ordenarPor('stock')"
              style="cursor: pointer"
            >
              Cantidad
              <i
                *ngIf="sortColumn === 'stock'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirection === 'asc',
                  'bi-caret-down-fill': sortDirection === 'desc'
                }"
              ></i>
            </th>

            <th scope="col" class="border-end">Descripción</th>
            <th scope="col" class="border-end">Opciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let producto of productos">
            <td class="border-end">{{ producto.nombre }}</td>
            <td class="border-end">{{ producto.categoria }}</td>
            <td class="border-end">{{ producto.precioCompra }}</td>
            <td class="border-end">{{ producto.precioVenta }}</td>
            <td class="border-end">{{ producto.stock }}</td>
            <td class="border-end">{{ producto.descripcion }}</td>
            <td>
              <button
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#productoModal"
                class="btn btn-outline-warning btn-sm me-2"
                (click)="editarProducto(producto)"
                title="Editar"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <!-- Agregar stock -->
              <button
                type="button"
                class="btn btn-outline-success btn-sm me-2"
                data-bs-toggle="modal"
                data-bs-target="#agregarStockModal"
                (click)="abrirModalAgregarStock(producto)"
                title="Agregar stock"
              >
                <i class="bi bi-plus-circle"></i>
              </button>
              <button
                type="button"
                class="btn btn-sm"
                [ngClass]="producto.estado ? 'btn-outline-danger' : 'btn-outline-success'"
                data-bs-toggle="modal"
                data-bs-target="#confirmarEliminarModal"
                (click)="productoAEliminar = producto"
                [title]="producto.estado ? 'Anular producto' : 'Reactivar producto'"
              >
                <i
                  class="bi"
                  [ngClass]="
                    producto.estado ? 'bi-x-circle text-danger' : 'bi-arrow-repeat text-success'
                  "
                ></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <mat-paginator
        [length]="totalElementos"
        [pageSize]="size"
        [pageIndex]="index"
        [pageSizeOptions]="[5, 10, 20]"
        (page)="cambiarPagina($event)"
      ></mat-paginator>
    </div>
  </div>

  <!-- Tabla de movimientos -->
  <div class="container mt-4" *ngIf="vistaActual === 'movimientos'">
    <h2 class="mb-3 text-center">Movimientos de productos</h2>

    <div class="table-responsive shadow-sm rounded">
      <table class="table table-hover align-middle border text-center">
        <thead class="table-dark">
          <tr>
            <th
              scope="col"
              class="border-end"
              (click)="ordenarMovimientosPor('fechaMovimiento')"
              style="cursor: pointer"
            >
              Fecha
              <i
                *ngIf="sortColumnMovimientos === 'fechaMovimiento'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirectionMovimientos === 'asc',
                  'bi-caret-down-fill': sortDirectionMovimientos === 'desc'
                }"
              ></i>
            </th>
            <th
              scope="col"
              class="border-end"
              (click)="ordenarMovimientosPor('productoNombre')"
              style="cursor: pointer"
            >
              Producto
              <i
                *ngIf="sortColumnMovimientos === 'productoNombre'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirectionMovimientos === 'asc',
                  'bi-caret-down-fill': sortDirectionMovimientos === 'desc'
                }"
              ></i>
            </th>
            <th
              scope="col"
              class="border-end"
              (click)="ordenarMovimientosPor('cantidad')"
              style="cursor: pointer"
            >
              Cantidad
              <i
                *ngIf="sortColumnMovimientos === 'cantidad'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirectionMovimientos === 'asc',
                  'bi-caret-down-fill': sortDirectionMovimientos === 'desc'
                }"
              ></i>
            </th>
            <th
              scope="col"
              class="border-end"
              (click)="ordenarMovimientosPor('tipo')"
              style="cursor: pointer"
            >
              Tipo
              <i
                *ngIf="sortColumnMovimientos === 'tipo'"
                class="bi"
                [ngClass]="{
                  'bi-caret-up-fill': sortDirectionMovimientos === 'asc',
                  'bi-caret-down-fill': sortDirectionMovimientos === 'desc'
                }"
              ></i>
            </th>
            <th scope="col" class="border-end">Observación</th>
            <th scope="col">Opciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let movimiento of movimientos">
            <td class="border-end">{{ movimiento.fechaMovimiento | date : 'short' }}</td>
            <td class="border-end">{{ movimiento.productoNombre }}</td>
            <td class="border-end">{{ movimiento.cantidad }}</td>
            <td class="border-end">{{ movimiento.tipo }}</td>
            <td class="border-end">{{ movimiento.observacion || '-' }}</td>
            <td class="text-center">
              <button
                type="button"
                class="btn btn-outline-warning btn-sm me-2"
                (click)="abrirModalEditarMovimiento(movimiento)"
                title="Editar movimiento"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-sm"
                (click)="abrirModalEliminarMovimiento(movimiento)"
                title="Eliminar movimiento"
              >
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="movimientos.length === 0">
            <td colspan="6" class="py-3 text-center">No se encontraron movimientos.</td>
          </tr>
        </tbody>
      </table>

      <mat-paginator
        [length]="totalMovimientos"
        [pageSize]="sizeMovimientos"
        [pageIndex]="indexMovimientos"
        [pageSizeOptions]="[5, 10, 20]"
        (page)="cambiarPaginaMovimientos($event)"
      ></mat-paginator>
    </div>
  </div>

  <!-- Modal Editar Movimiento -->
  <div
    class="modal fade"
    id="editarMovimientoModal"
    tabindex="-1"
    aria-labelledby="editarMovimientoLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editarMovimientoLabel">
            Editar Movimiento — {{ movimientoSeleccionado?.productoNombre }}
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="cerrarModalEditarMovimiento()"
          ></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="formularioMovimientoEditar" (ngSubmit)="guardarMovimientoEditado()">
            <div
              class="alert alert-danger py-2"
              role="alert"
              *ngIf="formularioMovimientoEditar.errors?.['backend'] as errorMovimientoEditar"
            >
              {{ errorMovimientoEditar }}
            </div>
            <div class="mb-3">
              <label class="form-label" for="cantidadMovimiento">Cantidad</label>
              <input
                id="cantidadMovimiento"
                type="number"
                class="form-control"
                formControlName="cantidad"
              />
              <div
                class="form-text text-danger"
                *ngIf="formularioMovimientoEditar.get('cantidad')?.errors?.['backend'] as errorCantidadMovimiento"
              >
                {{ errorCantidadMovimiento }}
              </div>
              <div
                class="form-text text-danger"
                *ngIf="
                  formularioMovimientoEditar.get('cantidad')?.hasError('noZero') &&
                  formularioMovimientoEditar.get('cantidad')?.touched
                "
              >
                La cantidad no puede ser cero.
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="observacionMovimiento">Observación</label>
              <textarea
                id="observacionMovimiento"
                class="form-control"
                rows="3"
                formControlName="observacion"
                maxlength="500"
              ></textarea>
              <div
                class="form-text text-danger"
                *ngIf="formularioMovimientoEditar.get('observacion')?.errors?.['backend'] as errorObservacionMovimiento"
              >
                {{ errorObservacionMovimiento }}
              </div>
            </div>
            <div class="text-end">
              <button type="submit" class="btn btn-primary" [disabled]="formularioMovimientoEditar.invalid">
                Guardar cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Eliminar Movimiento -->
  <div
    class="modal fade"
    id="eliminarMovimientoModal"
    tabindex="-1"
    aria-labelledby="eliminarMovimientoLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="eliminarMovimientoLabel">Eliminar movimiento</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            (click)="cerrarModalEliminarMovimiento()"
          ></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">
            ¿Estás seguro de eliminar el movimiento del producto
            <strong>{{ movimientoAEliminar?.productoNombre }}</strong>?
            La cantidad se establecerá en 0 y el stock se ajustará automáticamente.
          </p>
          <label for="observacionEliminarMovimiento" class="form-label">Observación (opcional)</label>
          <textarea
            id="observacionEliminarMovimiento"
            class="form-control"
            rows="3"
            [(ngModel)]="observacionEliminacionMovimiento"
            name="observacionEliminarMovimiento"
            maxlength="500"
          ></textarea>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="cerrarModalEliminarMovimiento()"
          >
            Cancelar
          </button>
          <button type="button" class="btn btn-danger" (click)="confirmarEliminarMovimiento()">
            Eliminar movimiento
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de producto -->
  <div
    class="modal fade"
    id="productoModal"
    tabindex="-1"
    aria-labelledby="productosLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Encabezado -->
        <div class="modal-header">
          <h5 class="modal-title" id="productosLabel">
            {{
              modoCreacionProducto
                ? productoSeleccionado
                  ? 'Editar Producto'
                  : 'Registrar Nuevo Producto'
                : 'Detalle Producto'
            }}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            (click)="ocultarFormularioProducto()"
          ></button>
        </div>

        <!-- Cuerpo -->
        <div class="modal-body">
          <!-- Formulario (solo si estamos en modo creación/edición) -->
          <div>
            <form [formGroup]="formularioProducto" (ngSubmit)="guardarProducto()">
              <div
                class="alert alert-danger py-2"
                role="alert"
                *ngIf="formularioProducto.errors?.['backend'] as errorFormulario"
              >
                {{ errorFormulario }}
              </div>
              <!-- Nombre -->
              <div class="mb-3">
                <label for="nombreProducto" class="form-label">Nombre</label>
                <div class="input-group">
                  <input
                    type="text"
                    id="nombreProducto"
                    class="form-control"
                    formControlName="nombre"
                    placeholder="Nombre del producto"
                  />
                </div>
                <div
                  class="form-text text-danger"
                  *ngIf="formularioProducto.get('nombre')?.errors?.['backend'] as errorNombre"
                >
                  {{ errorNombre }}
                </div>
              </div>
              <!-- Categoría -->
              <div class="mb-3">
                <label for="categoria" class="form-label">Categoría</label>
                <div class="input-group">
                  <select
                    id="categoria"
                    class="form-select"
                    formControlName="categoria"
                    name="categoria"
                  >
                    <option [ngValue]="null">Seleccionar</option>
                    <option *ngFor="let categoria of categoriasProductos" [value]="categoria">
                      {{ categoria }}
                    </option>
                  </select>
                </div>
                <div
                  class="form-text text-danger"
                  *ngIf="formularioProducto.get('categoria')?.errors?.['backend'] as errorCategoria"
                >
                  {{ errorCategoria }}
                </div>
              </div>

              <!-- Precio de compra -->
              <div class="mb-3">
                <label for="precioCompra" class="form-label">Precio de compra</label>
                <div class="input-group">
                  <input
                    type="number"
                    id="precioCompra"
                    class="form-control"
                    formControlName="precioCompra"
                    placeholder="0"
                    min="0"
                  />
                </div>
                <div
                  class="form-text text-danger"
                  *ngIf="
                    formularioProducto.get('precioCompra')?.errors?.['backend'] as errorPrecioCompra
                  "
                >
                  {{ errorPrecioCompra }}
                </div>
              </div>

              <!-- Precio de venta -->
              <div class="mb-3">
                <label for="precioVenta" class="form-label">Precio de venta</label>
                <div class="input-group">
                  <input
                    type="number"
                    id="precioVenta"
                    class="form-control"
                    formControlName="precioVenta"
                    placeholder="0"
                    min="0"
                  />
                </div>
                <div
                  class="form-text text-danger"
                  *ngIf="
                    formularioProducto.get('precioVenta')?.errors?.['backend'] as errorPrecioVenta
                  "
                >
                  {{ errorPrecioVenta }}
                </div>
              </div>

              <!-- Stock -->
              <div class="mb-3" *ngIf="productoSeleccionado === null">
                <label for="stock" class="form-label">Stock</label>
                <div class="input-group">
                  <input
                    type="number"
                    id="stock"
                    class="form-control"
                    formControlName="stock"
                    placeholder="0"
                    min="0"
                  />
                </div>
                <div
                  class="form-text text-danger"
                  *ngIf="formularioProducto.get('stock')?.errors?.['backend'] as errorStock"
                >
                  {{ errorStock }}
                </div>
              </div>
              <!-- Descripción -->
              <div class="mb-3">
                <label for="descripcionProducto" class="form-label">Descripción</label>
                <div class="input-group">
                  <input
                    type="text"
                    id="descripcionProducto"
                    class="form-control"
                    formControlName="descripcion"
                    placeholder="Descripción del producto"
                  />
                </div>
                <div
                  class="form-text text-danger"
                  *ngIf="
                    formularioProducto.get('descripcion')?.errors?.['backend'] as errorDescripcion
                  "
                >
                  {{ errorDescripcion }}
                </div>
              </div>

              <!-- Botón -->
              <div class="text-end">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="formularioProducto.invalid"
                >
                  Guardar producto
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ingresar Productos -->
  <div
    class="modal fade"
    id="ingresarProductosModal"
    tabindex="-1"
    aria-labelledby="ingresarProductosLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ingresarProductosLabel">Ingresar Productos</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            (click)="cerrarModalIngresarProductos()"
          ></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="formularioMovimientos">
            <div
              class="alert alert-danger py-2"
              role="alert"
              *ngIf="formularioMovimientos.errors?.['backend'] as errorMovimientos"
            >
              {{ errorMovimientos }}
            </div>
            <div
              class="alert alert-info py-2"
              role="alert"
              *ngIf="productosActivos.length === 0"
            >
              No hay productos activos disponibles para actualizar su stock.
            </div>
            <div formArrayName="movimientos">
              <div
                class="row g-3 align-items-end mb-3"
                *ngFor="let movimiento of movimientosFormArray.controls; let i = index"
                [formGroupName]="i"
              >
                <div class="col-md-5">
                  <label class="form-label">Producto</label>
                  <input type="hidden" formControlName="productoId" />
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Buscar producto"
                    formControlName="productoNombre"
                    [matAutocomplete]="autoProducto"
                    (input)="filtrarProductosMovimiento(i)"
                    (focus)="filtrarProductosMovimiento(i)"
                  />
                  <mat-autocomplete
                    #autoProducto="matAutocomplete"
                    (optionSelected)="seleccionarProductoMovimiento($event, i)"
                  >
                    <mat-option
                      *ngFor="let prod of productosFiltradosMovimientos[i]"
                      [value]="prod.nombre"
                    >
                      {{ prod.nombre }}
                    </mat-option>
                  </mat-autocomplete>
                  <div
                    class="form-text text-danger"
                    *ngIf="movimiento.get('productoNombre')?.errors?.['backend'] as errorProductoNombre"
                  >
                    {{ errorProductoNombre }}
                  </div>
                  <div
                    class="form-text text-danger"
                    *ngIf="movimiento.get('productoId')?.errors?.['backend'] as errorProductoId"
                  >
                    {{ errorProductoId }}
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Cantidad</label>
                  <input
                    type="number"
                class="form-control"
                formControlName="cantidad"
                placeholder="0"
              />
              <div
                class="form-text text-danger"
                *ngIf="movimiento.get('cantidad')?.errors?.['backend'] as errorCantidad"
              >
                {{ errorCantidad }}
              </div>
              <div
                class="form-text text-danger"
                *ngIf="movimiento.get('cantidad')?.hasError('noZero') && movimiento.get('cantidad')?.touched"
              >
                La cantidad no puede ser cero.
              </div>
            </div>
                <div class="col-md-3">
                  <label class="form-label">Observación</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="observacion"
                    placeholder="Opcional"
                  />
                </div>
                <div class="col-md-1 d-flex justify-content-center">
                  <button
                    type="button"
                    class="btn btn-outline-danger"
                    (click)="eliminarFilaMovimiento(i)"
                    [disabled]="movimientosFormArray.length === 1"
                    title="Eliminar fila"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </form>
          <div class="d-flex justify-content-end">
            <button
              type="button"
              class="btn btn-outline-secondary btn-sm"
              (click)="agregarFilaMovimiento()"
            >
              Agregar otro producto
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            data-bs-dismiss="modal"
            (click)="cerrarModalIngresarProductos()"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn btn-success"
            (click)="confirmarIngresoMasivo()"
            [disabled]="productosActivos.length === 0"
          >
            Confirmar ingreso
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Agregar Stock -->
  <div
    class="modal fade"
    id="agregarStockModal"
    tabindex="-1"
    aria-labelledby="agregarStockLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Encabezado -->
        <div class="modal-header">
          <h5 class="modal-title" id="agregarStockLabel">
            Agregar Stock — {{ productoParaSumar?.nombre }}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            (click)="cerrarModalAgregarStock()"
          ></button>
        </div>

        <!-- Cuerpo -->
        <div class="modal-body">
          <label for="cantidadAgregar" class="form-label">Cantidad a agregar</label>
          <input
            type="number"
            id="cantidadAgregar"
            class="form-control"
            [(ngModel)]="cantidadAgregar"
            placeholder="0"
          />
        </div>

        <!-- Pie -->
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-success"
            data-bs-dismiss="modal"
            (click)="confirmarAgregarStock()"
          >
            Agregar Cantidad
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Confirmar Eliminación -->
  <div
    class="modal fade"
    id="confirmarEliminarModal"
    tabindex="-1"
    aria-labelledby="confirmarEliminarLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmarEliminarLabel">Confirmar acción</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Cerrar"
          ></button>
        </div>

        <div class="modal-body text-center">
          <i class="bi bi-exclamation-triangle-fill text-warning fs-1 mb-3"></i>
          <p class="fs-5">
            ¿Estás seguro de que deseas
            <strong>{{ productoAEliminar?.estado ? 'anular' : 'reactivar' }}</strong>
            el producto
            <strong>{{ productoAEliminar?.nombre }}</strong
            >?
          </p>
        </div>

        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button
            type="button"
            class="btn"
            [ngClass]="productoAEliminar?.estado ? 'btn-danger' : 'btn-success'"
            data-bs-dismiss="modal"
            (click)="confirmarEliminacion()"
          >
            {{ productoAEliminar?.estado ? 'Anular' : 'Reactivar' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
